# *【实验项目一】数据表,创建索引,图创建,修改,删除的设计与完整性约束*

# Phase 1

## 1.创建基本表内容

### 1) 建立table

```sql
use ClassLearnBase

-- firstly create table
create table UserInfo(
CardId char(9) primary key,
StuName char(16),
Gender char(5) constraint GenderEnum check(Gender in ('男', '女')) default NULL,
-- constraint 后面不加括号，但是check后面要
Birthday Date,
BorrowVolume tinyint default 0,
WorkUnit char(32),
tel char(16),
e_mail char(64),
)
go

create table RentHis(
CardId char(9) foreign key references UserInfo(CardId),
BookId char(9) foreign key references BookInfo(BookId),
ChangeType Char(5) constraint RentOrReturn check(ChangeType in ('借', '还')) not null,
RentDate date not null,
ReturnDate date default null,
RentCount int,
WorkerId char(9) foreign key references Worker(WorkerId),
);

create table BookType(
TypeId char(9) primary key,
TypeName char(20),
);

create table Worker(
WorkerId char(9) primary key,
WorkerName char(25),
Gender char(5) check(Gender in ('男', '女')) default NULL,
Birthday Date,
tel char(16),
e_mail char(64),
);

create table BookInfo(
TypeId char(9) foreign key references BookType(TypeId),
BookId char(9) primary key,
BookName char(25),
BookAuthor char(15),
Publisher char(50),
Price int,
Purchase_Date Date,
Purchase_Nums int,
Copy_Counts int,
Stock int,
);`
```

### 2) 建立view

```sql
create view RentHis_Detail(图书编号,图书名称,借书证号,借出日期,归还日期,库存数)
as
select BookInfo.BookId, BookInfo.BookName,
UserInfo.CardId,
RentHis.RentDate, RentHis.RentDate,
BookInfo.Stock
from BookInfo, UserInfo, RentHis
where BookInfo.BookId = RentHis.BookId and RentHis.CardId = UserInfo.CardId 
and RentHis.ReturnDate is null
```

## 2.添加约束的方法

### 约束方法1：直接在后面加上约束条件

可以使用带约束对象的，也可以不使用

    Gender char(5) constraint GenderEnum check(Gender in ('男', '女')) default NULL,

### 约束方法2：在定义的末尾进行约束的添加

```sql
constraint WorkerGender check(Gender in ('男', '女')),
```

### 约束方法3：在声明后进行约束的添加

```sql
ALTER TABLE RentHis ADD CONSTRAINT RentOrReturn check(ChangeType in ('借', '还'));
```

## 3.查看和删除约束

### 1) view constraints

#### 1. method 1

```sql
SELECT * FROM all_constraints WHERE Table_Name = <TableName>;
```

#### 2. method 2

```sql
SELECT constraint_name, 
       constraint_type,
       search_condition
  FROM USER_CONSTRAINTS
 WHERE table_name = 'TEAMS';
```

#### 3. method 3

```sql
SELECT * FROM sys.objects
WHERE type_desc LIKE '%CONSTRAINT'
```

### 2) add constraints

```sql
alter table Score
add constraint useless check(degree>0);
```

### 3) drop constraints

```sql
alter table Score
drop constraint useless;
```

## 4.创建、删除默认和规则

### 添加默认

```sql
alter table RentHis add DEFAULT null for ReturnDate
```

### 删除默认

```sql
alter table BookInfo
add constraint DF_BOOKINFO_PURCHASETIME default getdate() for Purchase_Date;

alter table BookInfo
drop constraint DF_BOOKINFO_PURCHASETIME;
```

### 创建规则

```sql
CREATE RULE gd_rule  

AS  @sex in ('男','女')
```

### 删除规则

```sql
drop rule gd_rule;
```

# Phase 2

## 5.主键约束的特点和方法

```sql
alter table RentHis
add constraint PK_RentHis primary key(BookId,CardId,ChangeType)

alter table RentHis
drop PK_RentHis
```

## 6.唯一性约束

```sql
alter table UserInfo
add constraint UQ_Tel unique(tel)
```

## 7.默认约束，默认对象

## 8.check约束和规则对象

## 主键和外键约束实现参照完整性

# Phase 3

## 5.添加字段删除字段

### 1) 添加字段

```sql
alter table Worker
add Worker_UnUsedInfo char

select * from Worker
```

### 2) 删除字段

```sql
-- 删除列的时候要特指是列，不加特指的话默认删除的是约束关系
alter table Worker
drop column Worker_UnUsedInfo
```

### 3) 修改字段类型

```sql
alter table Worker
alter column Worker_UnUsedInfo int
```

### 4) 添加一个约束

## 4.创建索引和删除索引

```sql
-- 对书本建立索引
create index id_of_book on BookInfo(BookId)
-- 删除索引，这是sql server的语法
drop index BookInfo.id_of_book
```

## 5.创建视图，删除视图

### 1) 创建视图：

```sql
create view RentHis_Detail(图书编号,图书名称,借书证号,借出日期,归还日期,库存数)
as
select BookInfo.BookId, BookInfo.BookName,
UserInfo.CardId,
RentHis.RentDate, RentHis.RentDate,
BookInfo.Stock
from BookInfo, UserInfo, RentHis
where BookInfo.BookId = RentHis.BookId and RentHis.CardId = UserInfo.CardId 
and RentHis.ReturnDate is null
```

### 3) 删除视图：

```sql
drop view RentHis_Detail;
```
